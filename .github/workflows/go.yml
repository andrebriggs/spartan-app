name: Build_Test_Push

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  # AWS_REGION: us-east-1
  APP_NAME: spartan-app
  DOCKER_REPO: andrebriggs
  INTROSPECTION_ACCOUNT_NAME: abrigspksetup
  INTROSPECTION_PARTITION_KEY: spektate-key
  INTROSPECTION_TABLE_NAME: spektatetable
  IMAGE_TAG_NAME: ${{ env.GITHUB_REPOSITORY:$(date +%s) }}
  # DOCKER_PASSWORD: ${{ secrets.ACR_PASSWORD }}
  # NUGET_PASSWORD: ${{ secrets.PACKAGES_PAT }}
  # NUGET_SOURCE: https://nuget.pkg.github.com/pharos/index.json
  # NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Debug Env Vars
      run: |
        echo "IMAGE_TAG_NAME: $IMAGE_TAG_NAME"
        echo "GITHUB_RUN_ID: $GITHUB_RUN_ID"
        echo "GITHUB_RUN_NUMBER: $GITHUB_RUN_NUMBER"
        echo "GITHUB_ACTOR: $GITHUB_ACTOR"
        echo "GITHUB_WORKFLOW: $GITHUB_WORKFLOW"
        echo "GITHUB_REF: $GITHUB_REF"
        echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
        echo "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH"

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.15
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      run: |
        go get -v -t -d ./...
        go get -u golang.org/x/lint/golint
        if [ -f Gopkg.toml ]; then
            curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
            dep ensure
        fi

    # - name: Build
    #   run: go build -v .

    - name: Test
      run: |
        go test -v -coverprofile spartan.out . 
        go tool cover -html=spartan.out

    - name: Run vet & lint
      run: |
        go vet .
        golint .
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Update Spektate storage
      run: |
        set -e
        chmod +x ./bedrock_helpers.sh
        . ./bedrock_helpers.sh --source-only
        get_bedrock_version
        download_bedrock
        tag_name=$GITHUB_REPOSITORY:$GITHUB_RUN_ID
        commitId=$GITHUB_SHA
        commitId=$(echo "${commitId:0:7}")
        service=$APP_NAME
        url=$(git remote --verbose | grep origin | grep fetch | cut -f2 | cut -d' ' -f1)
        repourl=${url##*@}
        
        echo "./bedrock/bedrock deployment create -n $INTROSPECTION_ACCOUNT_NAME -k ${{ secrets.INTROSPECTION_ACCOUNT_KEY }} -t $INTROSPECTION_TABLE_NAME -p $INTROSPECTION_PARTITION_KEY --p1 $GITHUB_RUN_ID --image-tag $tag_name --commit-id $commitId --service $service --repository $repourl"

        ./bedrock/bedrock deployment create -n $INTROSPECTION_ACCOUNT_NAME -k ${{ secrets.INTROSPECTION_ACCOUNT_KEY }} -t $INTROSPECTION_TABLE_NAME -p $INTROSPECTION_PARTITION_KEY --p1 $GITHUB_RUN_ID --image-tag $tag_name --commit-id $commitId --service $service --repository $repourl
  
    # - name: Azure CLI script
    #   uses: azure/CLI@v1
    #   env: 
    #     creds: ${{ secrets.AZURE_CREDENTIALS }}
    #   with:
    #     inlineScript: |
    #       echo "az acr build -r $DOCKER_REPO --image $GITHUB_REPOSITORY:$(date +%s) ."
    #       az acr build -r $DOCKER_REPO --image $GITHUB_REPOSITORY:$(date +%s) .